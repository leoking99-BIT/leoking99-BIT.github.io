<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.2 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Several Ways of Writing a ROS Node - Kai Liu’s Homepage</title>
<meta name="description" content="The design of nodes varies according to the requirements of different applications. Selecting the right node pattern is pretty important for achieving certain goals.Here we mainly involve ros::spin(), ros::spinOnce(), timer, single-thread node and multi-thread node and nodelet topics.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Kai Liu's Homepage">
<meta property="og:title" content="Several Ways of Writing a ROS Node">
<meta property="og:url" content="https://leoking99-bit.github.io/tools/several-ways-of-writing-a-ros-node/">


  <meta property="og:description" content="The design of nodes varies according to the requirements of different applications. Selecting the right node pattern is pretty important for achieving certain goals.Here we mainly involve ros::spin(), ros::spinOnce(), timer, single-thread node and multi-thread node and nodelet topics.">







  <meta property="article:published_time" content="2018-10-01T00:00:00+08:00">





  

  


<link rel="canonical" href="https://leoking99-bit.github.io/tools/several-ways-of-writing-a-ros-node/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Kai Liu",
      "url": "https://leoking99-BIT.github.io",
      "sameAs": "https://leoking99-bit.github.io/"
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Kai Liu's Homepage Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->


<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KQ4PZJF');</script>
<!-- End Google Tag Manager -->

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Several Ways of Writing a ROS Node | Kai Liu’s Homepage</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Several Ways of Writing a ROS Node" />
<meta name="author" content="Kai Liu" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The design of nodes varies according to the requirements of different applications. Selecting the right node pattern is pretty important for achieving certain goals. Here we mainly involve ros::spin(), ros::spinOnce(), timer, single-thread node and multi-thread node and nodelet topics." />
<meta property="og:description" content="The design of nodes varies according to the requirements of different applications. Selecting the right node pattern is pretty important for achieving certain goals. Here we mainly involve ros::spin(), ros::spinOnce(), timer, single-thread node and multi-thread node and nodelet topics." />
<link rel="canonical" href="https://leoking99-bit.github.io/tools/several-ways-of-writing-a-ros-node/" />
<meta property="og:url" content="https://leoking99-bit.github.io/tools/several-ways-of-writing-a-ros-node/" />
<meta property="og:site_name" content="Kai Liu’s Homepage" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-10-01T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Several Ways of Writing a ROS Node" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@Kai Liu" />
<script type="application/ld+json">
{"description":"The design of nodes varies according to the requirements of different applications. Selecting the right node pattern is pretty important for achieving certain goals. Here we mainly involve ros::spin(), ros::spinOnce(), timer, single-thread node and multi-thread node and nodelet topics.","author":{"@type":"Person","name":"Kai Liu"},"@type":"BlogPosting","url":"https://leoking99-bit.github.io/tools/several-ways-of-writing-a-ros-node/","headline":"Several Ways of Writing a ROS Node","dateModified":"2018-10-01T00:00:00+08:00","datePublished":"2018-10-01T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://leoking99-bit.github.io/tools/several-ways-of-writing-a-ros-node/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body class="layout--single wide">
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQ4PZJF"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Kai Liu's Homepage</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="https://leoking99-BIT.github.io/" >Home</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="https://leoking99-BIT.github.io/videos/" >Videos</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="https://leoking99-BIT.github.io/projects_index/" >Projects</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="https://leoking99-BIT.github.io/blogs/" >Blogs</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="https://github.com/leoking99-BIT" >Codes</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="https://leoking99-BIT.github.io/publications/" >Publications</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="https://leoking99-BIT.github.io/about/" >CV</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="https://leoking99-BIT.github.io/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
          <a href="/categories/#tools" itemprop="item"><span itemprop="name">Tools</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Several Ways of Writing a ROS Node</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/kai_self.jpg" alt="Kai Liu" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Kai Liu</h3>
    
    
      <p class="author__bio" itemprop="description">
        Engineer @ UISEE, PhD @ Beijing Institute of Technology, Visiting scholar @ Ohio State University.
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Beijing, China</span>
        </li>
      

      
        <li>
          <a href="https://leoking99-bit.github.io/" itemprop="url">
            <i class="fas fa-fw fa-link" aria-hidden="true"></i> Website
          </a>
        </li>
      

      
        <li>
          <a href="mailto:leoking1025@bit.edu.cn">
            <meta itemprop="email" content="leoking1025@bit.edu.cn" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/https://www.linkedin.com/in/kai-liu-032213100/" itemprop="sameAs">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/leoking99-BIT" itemprop="sameAs">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      
        
          <li>
            <a href="https://www.youtube.com/user/UCsgiPR2CMjsWcrtFIXQS6EQ" itemprop="sameAs">
              <i class="fab fa-fw fa-youtube" aria-hidden="true"></i> YouTube
            </a>
          </li>
        
      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Several Ways of Writing a ROS Node">
    <meta itemprop="description" content="The design of nodes varies according to the requirements of different applications. Selecting the right node pattern is pretty important for achieving certain goals.Here we mainly involve ros::spin(), ros::spinOnce(), timer, single-thread node and multi-thread node and nodelet topics.">
    <meta itemprop="datePublished" content="October 01, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Several Ways of Writing a ROS Node
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>The design of nodes varies according to the requirements of different applications. Selecting the right node pattern is pretty important for achieving certain goals.
Here we mainly involve <code class="highlighter-rouge">ros::spin()</code>, <code class="highlighter-rouge">ros::spinOnce()</code>, <code class="highlighter-rouge">timer</code>, <code class="highlighter-rouge">single-thread node</code> and <code class="highlighter-rouge">multi-thread node</code> and <code class="highlighter-rouge">nodelet</code> topics.</p>

<h2 id="single-thread-node">Single-thread Node</h2>

<h3 id="rosspinonce-vs-rosspin">ros::spinOnce vs ros::spin</h3>

<p>The <a href="http://wiki.ros.org/ROS/Tutorials/WritingPublisherSubscriber%28c%2B%2B%29">ROS tutorials</a> explain how to write a simple publisher and subscriber clearly, which also demonstrate the usage of <code class="highlighter-rouge">ros::spinOnce()</code> and <code class="highlighter-rouge">ros::spin()</code> respectively. Note that if you write a node the same as the example from the tutorials, don’t omit <code class="highlighter-rouge">spinOnce()</code> or <code class="highlighter-rouge">spin()</code>, or you can’t trigger the callback functions of subscribers and timers. When nodes receive messages via topics or service, they do not process them immediately. All the callbacks are on-hold in a line until the <code class="highlighter-rouge">spinOnce()</code> or <code class="highlighter-rouge">spin()</code> is called. These two <code class="highlighter-rouge">spins</code> are slightly different.</p>

<p><code class="highlighter-rouge">ros::spinOnce()</code> asks ROS to execute all the pending callbacks of subscribers and timers once, then return control back to us. You can keep doing your work.</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ros</span><span class="o">::</span><span class="n">spinOnce</span><span class="p">()</span> <span class="c1">// ask ROS to handle callbacks  </span>
<span class="n">doYourWork</span><span class="p">()</span>    <span class="c1">// this line will be executed</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">ros::spin()</code> is like a button without going back, which means asking ROS to wait for and execute callbacks until the node shuts down. You fully give control to ROS.</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ros</span><span class="o">::</span><span class="n">spin</span><span class="p">()</span>  <span class="c1">// ask ROS to handle callbacks</span>
<span class="n">youWantToDoYourWork</span><span class="p">()</span>  <span class="c1">// this line will never be executed.</span>
</code></pre></div></div>

<p>Roughly speaking, <code class="highlighter-rouge">ros::spin()</code> is equivalent to the loop below:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span><span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">spinOnce</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Thus, <code class="highlighter-rouge">spinOnce()</code> gives you more control on when to process callbacks. You need to be aware of and control the time between two <code class="highlighter-rouge">spinOnce()</code> by yourself and don’t let the callbacks be activated too late.  This is how publisher in tutorial use <code class="highlighter-rouge">spinOnce()</code> with <code class="highlighter-rouge">ros::rate.sleep</code> for repetitive work. In the simple subscriber, you don’t need to process information periodically, only callbacks need to be handled. For this case, <code class="highlighter-rouge">ros::spin()</code> is enough.</p>

<p>But this doesn’t mean you can’t do periodic work by using <code class="highlighter-rouge">ros::spin()</code>. By combining <code class="highlighter-rouge">ros::spin()</code> with timers, you can also achieve the same goal as following codes:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ros</span><span class="o">::</span><span class="n">Rate</span> <span class="nf">loop_rate</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">doYourWork</span><span class="p">();</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">spinOnce</span><span class="p">();</span>
  <span class="n">loop_rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Timers are(have) callbacks as well, right?</p>

<h3 id="class-node-pattern">Class Node Pattern</h3>
<p>The way that the <a href="http://wiki.ros.org/ROS/Tutorials/WritingPublisherSubscriber%28c%2B%2B%29">ROS tutorials</a> write a node (I call it <strong>simple node pattern</strong>) is clear and simple. But we want more – a more modular, clear, organized node structure.</p>

<p>Here is the <strong>class node pattern</strong> I prefer in practice:
<img src="/assets/images/nodeclass.png" alt="nodeclass" />
You can find the example node class codes in <a href="https://github.com/yuzhangbit/ros_node_pattern/blob/master/demo/include/simple_node_class.hpp"><code class="highlighter-rouge">demo/include/simple_node_class.hpp</code></a> and <a href="https://github.com/yuzhangbit/ros_node_pattern/blob/master/demo/src/simple_node_class.cpp"><code class="highlighter-rouge">demo/src/simple_node_class.cpp</code></a> in <a href="https://github.com/yuzhangbit/ros_node_pattern">ros_node_pattern</a>.</p>

<p>In <code class="highlighter-rouge">construtor</code> you can pass in the ros node handle and private handle. You can define subscribers, publishers, timers, update parameters from servers, and bind the callbacks in <code class="highlighter-rouge">init()</code> functions, do periodic work in <code class="highlighter-rouge">timerCallback()</code> (for exmaple, publish a message  in a fixed rate the same as in the while loop), buffer or update incoming information in <code class="highlighter-rouge">subscriberCallback()</code>. Then instantiate a node using the class as blow:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "node_class.hpp"
#include &lt;string&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">node_name</span> <span class="o">=</span> <span class="s">"simple_class_node"</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">node_name</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh_private</span><span class="p">(</span><span class="s">"~"</span><span class="p">);</span>
    <span class="n">NodeClass</span> <span class="n">node</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="n">nh_private</span><span class="p">);</span>
    <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">"Initialized a single-thread class node."</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">spin</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Seems readable, clean and elegant!</p>

<p>Although we encourage only updating or buffering information in the <code class="highlighter-rouge">subscriberCallback()</code> and leaving computation-intensive work to the main loop or <code class="highlighter-rouge">timerCallback()</code>, someone may do some heavy work that takes time in the callbacks on occasion. If you expect to publish a message in 10hz in the periodic loop while the <code class="highlighter-rouge">subscriberCallback()</code> blocks for 200ms, your publishing rate is going to drop to 5hz for sure.<br />
This is caused by the single thread mode we use in the simple ros node with <code class="highlighter-rouge">ros::spin()</code> or <code class="highlighter-rouge">ros::spinOnce()</code>. The main loop and all the callbacks are running in a single thread in sequence. The publishing rate will be determined by the summation of time consumed by all the callbacks if the main loop rate is higher.</p>

<p>I provide such examples using both <code class="highlighter-rouge">spinOnce()</code> and <code class="highlighter-rouge">spin()</code> with above class node pattern in the <a href="https://github.com/yuzhangbit/ros_node_pattern/tree/master/demo">demo</a> package of <a href="https://github.com/yuzhangbit/ros_node_pattern">ros_node_pattern</a> repo.</p>

<ul>
  <li><a href="https://github.com/yuzhangbit/ros_node_pattern/blob/master/demo/src/simple_node.cpp">simple_node</a>: <code class="highlighter-rouge">spinOnce()</code> with a while loop implementation, <strong>simple node pattern</strong></li>
  <li><a href="https://github.com/yuzhangbit/ros_node_pattern/blob/master/demo/src/single_thread_node_instance.cpp">single_thread_node_instance</a>: <code class="highlighter-rouge">spin()</code> with a timer in the node class implementaion, <strong>class node pattern</strong></li>
</ul>

<p>Both periodic loops are set to 10hz. Three subscribers are defined to subscribing to the same topic. Each subscriber callback will block the program for 200ms. Then the publishing rate becomes 1.666hz(1/(0.2 + 0.2 + 0.2)hz) instead of 10hz.</p>

<p>Below are steps to recreate this result.</p>
<ol>
  <li>clone the repo to your <code class="highlighter-rouge">catkin_ws/src</code></li>
  <li><code class="highlighter-rouge">catkin build</code></li>
  <li><code class="highlighter-rouge">roscore</code></li>
  <li><code class="highlighter-rouge">rosrun demo simple_node</code> or <code class="highlighter-rouge">rosrun demo single_thread_node_instance</code> in another terminal.</li>
  <li>Check the publishing rate
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  rostopic hz /publisher
</code></pre></div>    </div>
    <p>You should get 10hz roughly.</p>
  </li>
  <li>Now trigger the subscriber callbacks with a simple python publisher in <a href="https://github.com/yuzhangbit/ros_node_pattern/blob/master/demo/scripts/sender.py">demo/scripts/sender.py</a>.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  python sender.py
</code></pre></div>    </div>
  </li>
  <li>Now check the publishing rate again.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  rostopic hz /publisher
</code></pre></div>    </div>
    <p>You should get 1.666hz roughly. You can also check the thread ID in the console as well.</p>
  </li>
</ol>

<p>This toy example explain why we should only update information in subscriber callback functions rather than perform algorithm processing in callbacks of a single-thread ROS node.</p>

<h2 id="multi-thread-node">Multi-thread Node</h2>
<p>The limitation of single-thread node is pretty obvious. What if I have to spend some time in the subscriber callback functions? What if I want to have two timers in different spinning rate? The solution really comes down to the multi-thread version of ROS node.</p>

<h3 id="multithreadedspinner-vs-asyncspinner">MultiThreadedSpinner vs AsyncSpinner</h3>
<p>We can easily implement the multi-thread ros node using the same node class even without modifications when instantiating the node class with <code class="highlighter-rouge">MultiThreadedSpinner</code> or <code class="highlighter-rouge">AsyncSpinner</code> as below.</p>

<ul>
  <li>MultiThreadedSpinner version in <a href="https://github.com/yuzhangbit/ros_node_pattern/blob/master/demo/src/multi_thread_node_instance.cpp">demo/src/multi_thread_node_instance.cpp</a>
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "node_class.hpp"
#include &lt;string&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">node_name</span> <span class="o">=</span> <span class="s">"simple_class_node"</span><span class="p">;</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">node_name</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh_private</span><span class="p">(</span><span class="s">"~"</span><span class="p">);</span>
  <span class="n">NodeClass</span> <span class="n">node</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="n">nh_private</span><span class="p">);</span>
  <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">"Initialized a multi-thread node."</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">MultiThreadedSpinner</span> <span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>   <span class="c1">// Use 4 threads</span>
  <span class="n">ROS_INFO_STREAM</span><span class="p">(</span><span class="s">"Main loop in thread:"</span> <span class="o">&lt;&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">get_id</span><span class="p">());</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>AsyncSpinner version in <a href="https://github.com/yuzhangbit/ros_node_pattern/blob/master/demo/src/async_multi_thread_node_instance.cpp">demo/src/async_multi_thread_node_instance.cpp</a>
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "node_class.hpp"
#include &lt;string&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">node_name</span> <span class="o">=</span> <span class="s">"simple_class_node"</span><span class="p">;</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">node_name</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh_private</span><span class="p">(</span><span class="s">"~"</span><span class="p">);</span>
  <span class="n">NodeClass</span> <span class="n">node</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="n">nh_private</span><span class="p">);</span>
  <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">"Initialized an async multi-thread node."</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">AsyncSpinner</span> <span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>  <span class="c1">// Use 4 threads</span>
  <span class="n">ROS_INFO_STREAM</span><span class="p">(</span><span class="s">"Main loop in thread:"</span> <span class="o">&lt;&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">get_id</span><span class="p">());</span>
  <span class="n">s</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">waitForShutdown</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Both versions are multi-thread ros nodes. Now every callback gets a thread to use. Here are differences of <code class="highlighter-rouge">MultiThreadedSpinner</code> and <code class="highlighter-rouge">AsyncSpinner</code> explained by <a href="http://wiki.ros.org/roscpp/Overview/Callbacks%20and%20Spinning">roscpp/Overview/Callbacks and Spinning</a>.</p>
<blockquote>
  <p><strong>MultiThreadedSpinner</strong> is a blocking spinner, similar to ros::spin(). You can specify a number of threads in its constructor, but if unspecified (or set to 0), it will use a thread for each CPU core.</p>
</blockquote>

<blockquote>
  <p>A more useful threaded spinner is the <strong>AsyncSpinner</strong>. Instead of a blocking spin() call, it has start() and stop() calls, and will automatically stop when it is destroyed.</p>
</blockquote>

<p><code class="highlighter-rouge">AsyncSpinner</code> provides more control to users than <code class="highlighter-rouge">MultiThreadedSpinner</code>, which is similar to <code class="highlighter-rouge">spinOnce()</code>. If you want to update the data of the node, you may need to put a mutex in your callback function. Another thing you need to note is that you need <code class="highlighter-rouge">ros::waitForShutdown()</code> after the spinner.start() for <code class="highlighter-rouge">AsyncSpinner</code>, or the ros node will only spin once.</p>

<p>To prove that the multi-thread versions are working, you can repeat steps above by replacing step 4 with <code class="highlighter-rouge">rosrun demo multi_thread_node_instance</code> or <code class="highlighter-rouge">rosrun demo async_multi_thread_node_instance</code>.</p>

<p>You will get 10hz in step 5 and step 7. You can also check the thread ID of every callback function or the main loop.</p>

<h2 id="nodelet-node-pattern">Nodelet Node Pattern</h2>
<p>To be done.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#programming" class="page__taxonomy-item" rel="tag">Programming</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ros" class="page__taxonomy-item" rel="tag">ROS</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#tools" class="page__taxonomy-item" rel="tag">Tools</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-10-01T00:00:00+08:00">October 01, 2018</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Several+Ways+of+Writing+a+ROS+Node%20https%3A%2F%2Fleoking99-bit.github.io%2Ftools%2Fseveral-ways-of-writing-a-ros-node%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fleoking99-bit.github.io%2Ftools%2Fseveral-ways-of-writing-a-ros-node%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=https%3A%2F%2Fleoking99-bit.github.io%2Ftools%2Fseveral-ways-of-writing-a-ros-node%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fleoking99-bit.github.io%2Ftools%2Fseveral-ways-of-writing-a-ros-node%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/tools/highlighting-author-name-for-IEEEtran-style/" class="pagination--pager" title="Highlighting an author’s name for CV using IEEEtran
">Previous</a>
    
    
      <a href="/tools/porting-apollo/" class="pagination--pager" title="Using Apollo Algorithms in Your Normal ROS Package
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a Comment</h4>
      <section class="fb-comments" data-href="https://leoking99-bit.github.io/tools/several-ways-of-writing-a-ros-node/" data-mobile="true" data-num-posts="10" data-width="100%" data-colorscheme="dark"></section>
    
</div>
    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/default_teaser.jpg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tools/nvidia-driver-and-cuda9-installation/" rel="permalink">Nvidia Driver and Cuda9.0 Installation
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Tested hardware and OS configuration:

  OS: Ubuntu 16.04 LTS
  NVIDIA Graphic Card: Quadro M1000M
  Cuda Version: 9.0
  Graphic Card Driver Version: 410.xx
...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/default_teaser.jpg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tools/use-apt-get-behind-socks5-proxy/" rel="permalink">Use apt-get behind a socks5 proxy
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Nothing would be more frustrating than to install apt packages from sources outside of China, especially from PPA.
If you try to update the c++ compiler to g...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/default_teaser.jpg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tools/porting-apollo/" rel="permalink">Using Apollo Algorithms in Your Normal ROS Package
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">This blog will introduce how the port_apollo repository converts an apollo module to a normal ROS package and uses Apollo algorithms in your own ros package ...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/assets/images/default_teaser.jpg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tools/highlighting-author-name-for-IEEEtran-style/" rel="permalink">Highlighting an author’s name for CV using IEEEtran
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Highlighting a specific author’s name is useful and widely used in CV. But there is no elegant way to do it with existing latex packages.
The IEEEtran.bst st...</p>
  </article>
</div>
        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Kai Liu. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-118867307-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118867307-1', { 'anonymize_ip': false});
</script>






    <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
  



  </body>
</html>
